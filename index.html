<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Âêâ‰ºäÂç°ÂìáÊóÖ‰∫∫ÊâãÂ∏≥</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fdfbf7;
            -webkit-tap-highlight-color: transparent;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Mobile Safe Area Fixes */
        .pt-safe-top {
            padding-top: env(safe-area-inset-top);
        }
        .pb-safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Import Map for React & Dependencies -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>

    <!-- App Logic -->
    <script type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, Trash2, Wallet, CreditCard, Download, Smartphone, Train, 
            ShoppingBag, Users, X, CheckCircle, Calendar, MapPin, Heart, 
            FileText, Edit2, Save, RotateCcw, Sparkles, Camera, Wand2, 
            Share, Info, Image as ImageIcon, Loader2, Settings, Calculator,
            ChevronLeft, ChevronRight, Map, AlertTriangle
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInAnonymously, 
            signInWithCustomToken 
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            deleteDoc, 
            updateDoc,
            setDoc,
            doc, 
            onSnapshot, 
            serverTimestamp,
            query,
            orderBy
        } from 'firebase/firestore';

        // --- Firebase Config Handling ---
        // ÁÇ∫‰∫ÜËÆìÈÄô‰ªΩ HTML ÂèØ‰ª•Âú®Ê≤íÊúâÁí∞Â¢ÉËÆäÊï∏ÁöÑÊÉÖÊ≥Å‰∏ãÈÅãË°åÔºåÊàëÂÄëÂÅö‰∫Ü‰∏Ä‰∫õÂÆâÂÖ®Ê™¢Êü•
        const getFirebaseConfig = () => {
            if (typeof __firebase_config !== 'undefined') {
                return JSON.parse(__firebase_config);
            }
            // Â¶ÇÊûúÊ≤íÊúâÁí∞Â¢ÉËÆäÊï∏ÔºåÈÄôË£°ÊúÉÂõûÂÇ≥ nullÔºåApp ÊúÉÈ°ØÁ§∫ÈåØË™§Êàñ‰ΩøÁî®Êú¨Âú∞Â≠òÂÑ≤Ê®°Êì¨ÔºàÂ¶ÇÊûúÈúÄË¶ÅÈÄ≤ÈöéÂäüËÉΩÔºâ
            // Âú®Ê≠§Á§∫ÁØÑ‰∏≠ÔºåÊàëÂÄëÂÅáË®≠Áí∞Â¢ÉËÆäÊï∏ÊúÉË¢´Ê≥®ÂÖ•ÔºåÊàñËÄÖÊÇ®ÂèØ‰ª•ÊâãÂãïÂ°´ÂÖ•ÊÇ®ÁöÑ Config
            console.warn("Firebase config not found. Please ensure __firebase_config is defined.");
            return {}; 
        };

        const firebaseConfig = getFirebaseConfig();
        // Á∞°ÂñÆÁöÑÂàùÂßãÂåñÊ™¢Êü•ÔºåÈÅøÂÖçÂ†±ÈåØ
        const app = Object.keys(firebaseConfig).length > 0 ? initializeApp(firebaseConfig) : null;
        const auth = app ? getAuth(app) : null;
        const db = app ? getFirestore(app) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const apiKey = ""; // Gemini API Key

        // --- Defaults ---
        const DEFAULT_CURRENCIES = [
            { code: 'TWD', label: 'Âè∞Âπ£', symbol: 'NT$', flag: 'üáπüáº', rate: 1 },
            { code: 'JPY', label: 'Êó•Âπ£', symbol: '¬•', flag: 'üáØüáµ', rate: 0.215 },
            { code: 'USD', label: 'ÁæéÂÖÉ', symbol: '$', flag: 'üá∫üá∏', rate: 32.5 },
        ];

        const DEFAULT_PAYMENT_METHODS = [
            { id: 'cash', name: 'ÁèæÈáë', iconName: 'Wallet' },
            { id: 'fubon_j', name: 'ÂØåÈÇ¶ J Âç°', iconName: 'CreditCard' },
            { id: 'apple_pay', name: 'Apple Pay', iconName: 'Smartphone' },
            { id: 'suica', name: 'Ë•øÁìúÂç°', iconName: 'Train' },
        ];

        const DEFAULT_DAYS = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5'];

        function App() {
            // Â¶ÇÊûúÊ≤íÊúâ FirebaseÔºåÈ°ØÁ§∫ÊèêÁ§∫
            if (!app) {
                return React.createElement('div', { className: "flex items-center justify-center h-screen bg-gray-50 p-6 text-center" }, 
                    React.createElement('div', null,
                        React.createElement(AlertTriangle, { className: "mx-auto text-red-500 mb-4", size: 48 }),
                        React.createElement('h1', { className: "text-xl font-bold mb-2" }, "Áº∫Â∞ë Firebase Ë®≠ÂÆö"),
                        React.createElement('p', { className: "text-gray-500" }, "Ê≠§ÊáâÁî®Á®ãÂºèÈúÄË¶Å Firebase Áí∞Â¢ÉÊâçËÉΩÈÅãË°å„ÄÇ")
                    )
                );
            }

            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('accounting');
            
            // --- Settings State ---
            const [currencies, setCurrencies] = useState(DEFAULT_CURRENCIES);
            const [paymentMethods, setPaymentMethods] = useState(DEFAULT_PAYMENT_METHODS);
            const [tripDays, setTripDays] = useState(DEFAULT_DAYS);
            const [totalBudget, setTotalBudget] = useState(50000);

            // --- Input State for Settings ---
            const [newPaymentName, setNewPaymentName] = useState('');
            const [newCurrencyCode, setNewCurrencyCode] = useState('');
            const [newCurrencyRate, setNewCurrencyRate] = useState('');

            // --- Data State ---
            const [transactions, setTransactions] = useState([]);
            const [shoppingList, setShoppingList] = useState([]);
            const [schedule, setSchedule] = useState([]);
            const [dailyPhotos, setDailyPhotos] = useState({});

            // --- UI/Form State ---
            const [amount, setAmount] = useState('');
            const [description, setDescription] = useState('');
            const [type, setType] = useState('expense');
            const [currency, setCurrency] = useState('JPY'); 
            const [paymentMethod, setPaymentMethod] = useState('');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [usageType, setUsageType] = useState('self');
            const [targetName, setTargetName] = useState('');
            
            const [scheduleDay, setScheduleDay] = useState('Day 1');
            const [dayViewStartIndex, setDayViewStartIndex] = useState(0);
            const [newEventTitle, setNewEventTitle] = useState('');
            const [newEventTime, setNewEventTime] = useState('');
            const [newEventLocation, setNewEventLocation] = useState('');
            const [editingEventId, setEditingEventId] = useState(null);

            // --- Modals ---
            const [showSettlementModal, setShowSettlementModal] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);
            const [showScheduleImportModal, setShowScheduleImportModal] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [showCalculatorModal, setShowCalculatorModal] = useState(false);
            const [showInstallGuide, setShowInstallGuide] = useState(false);
            const [confirmModal, setConfirmModal] = useState({ show: false, title: '', message: '', onConfirm: () => {} });

            // --- Import/Calc/AI Vars ---
            const [importText, setImportText] = useState('');
            const [scheduleImportText, setScheduleImportText] = useState('');
            const [scheduleImportTargetDay, setScheduleImportTargetDay] = useState('Day 1');
            const [isAnalyzingImage, setIsAnalyzingImage] = useState(false);
            const fileInputRef = useRef(null);
            const photoInputRef = useRef(null); 
            const [calcAmount, setCalcAmount] = useState('');
            const [calcRate, setCalcRate] = useState('0.215');
            const [calcResult, setCalcResult] = useState(0);

            // --- Setup ---
            useEffect(() => {
                document.documentElement.style.fontSize = '17px'; 
            }, []);

            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);
                };
                initAuth();
                return onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user) return;

                const unsubTrx = onSnapshot(query(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), orderBy('createdAt', 'desc')), snap => 
                    setTransactions(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=>new Date(b.date)-new Date(a.date)))
                );
                const unsubShop = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'shopping_list'), snap => 
                    setShoppingList(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=>(a.isBought===b.isBought?0:a.isBought?1:-1)))
                );
                const unsubSch = onSnapshot(query(collection(db, 'artifacts', appId, 'users', user.uid, 'schedule'), orderBy('time')), snap => 
                    setSchedule(snap.docs.map(d => ({ id: d.id, ...d.data() })))
                );
                const unsubPhotos = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'daily_photos'), snap => {
                    const photos = {};
                    snap.docs.forEach(doc => photos[doc.id] = doc.data().image);
                    setDailyPhotos(photos);
                });

                const settingsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config');
                const unsubSettings = onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.currencies) setCurrencies(data.currencies);
                        if (data.paymentMethods) setPaymentMethods(data.paymentMethods);
                        if (data.tripDays) setTripDays(data.tripDays);
                        if (data.totalBudget) setTotalBudget(data.totalBudget);
                        if (!paymentMethod && data.paymentMethods?.length > 0) setPaymentMethod(data.paymentMethods[0].id);
                    } else {
                        setDoc(settingsRef, { currencies: DEFAULT_CURRENCIES, paymentMethods: DEFAULT_PAYMENT_METHODS, tripDays: DEFAULT_DAYS, totalBudget: 50000 }, { merge: true });
                    }
                });

                return () => { unsubTrx(); unsubShop(); unsubSch(); unsubSettings(); unsubPhotos(); };
            }, [user]);

            // --- Logic Helpers ---
            const fileToBase64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
            
            const getCurrencySymbol = (code) => currencies.find(c => c.code === code)?.symbol || '$';
            
            const saveSettings = async (newConfig) => {
                if (!user) return;
                await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config'), newConfig, { merge: true });
            };

            const handleAddPaymentMethod = () => {
                if (newPaymentName.trim()) {
                    const newMethods = [...paymentMethods, { id: crypto.randomUUID(), name: newPaymentName, iconName: 'CreditCard' }];
                    setPaymentMethods(newMethods);
                    saveSettings({ paymentMethods: newMethods });
                    setNewPaymentName('');
                }
            };

            const handleDeletePaymentMethod = (id) => {
                setConfirmModal({
                    show: true,
                    title: 'Âà™Èô§ÊîØ‰ªòÂ∑•ÂÖ∑',
                    message: 'Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÊîØ‰ªòÂ∑•ÂÖ∑ÂóéÔºü',
                    onConfirm: () => {
                        if (paymentMethods.length <= 1) return alert("Ëá≥Â∞ëË¶ÅÁïô‰∏ÄÂÄãÔºÅ");
                        const newMethods = paymentMethods.filter(p => p.id !== id);
                        setPaymentMethods(newMethods);
                        saveSettings({ paymentMethods: newMethods });
                        if (paymentMethod === id) setPaymentMethod(newMethods[0].id);
                        setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} });
                    }
                });
            };

            const handleAddCurrency = () => {
                if (newCurrencyCode.trim()) {
                    const code = newCurrencyCode.toUpperCase();
                    const rate = parseFloat(newCurrencyRate) || 1;
                    const newCurrencies = [...currencies, { code, label: code, symbol: '$', flag: 'üåç', rate }];
                    setCurrencies(newCurrencies);
                    saveSettings({ currencies: newCurrencies });
                    setNewCurrencyCode('');
                    setNewCurrencyRate('');
                }
            };

            const handleDeleteCurrency = (code) => {
                setConfirmModal({
                    show: true,
                    title: 'Âà™Èô§Âπ£Âà•',
                    message: `Á¢∫ÂÆöË¶ÅÂà™Èô§ ${code} ÂóéÔºü`,
                    onConfirm: () => {
                        if (currencies.length <= 1) return alert("Ëá≥Â∞ëË¶ÅÁïô‰∏ÄÁ®ÆÂπ£Âà•ÔºÅ");
                        const newCurrencies = currencies.filter(c => c.code !== code);
                        setCurrencies(newCurrencies);
                        saveSettings({ currencies: newCurrencies });
                        if (currency === code) setCurrency(newCurrencies[0].code);
                        setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} });
                    }
                });
            };

            const handleAddDay = () => {
                const lastDay = tripDays[tripDays.length - 1]; 
                const lastNum = parseInt(lastDay.replace('Day ', '')) || tripDays.length;
                const newDays = [...tripDays, `Day ${lastNum + 1}`];
                setTripDays(newDays);
                saveSettings({ tripDays: newDays });
                if (newDays.length > 3) setDayViewStartIndex(newDays.length - 3);
                setScheduleDay(newDays[newDays.length - 1]);
            };

            const handleDeleteCurrentDay = () => {
                setConfirmModal({
                    show: true,
                    title: 'Âà™Èô§Â§©Êï∏',
                    message: `Á¢∫ÂÆöË¶ÅÂà™Èô§ ${scheduleDay} ÂóéÔºüÂ¶ÇÊûúÈÄôÂ§©ÊúâË°åÁ®ã‰πüÊúÉ‰∏çË¶ãÂñîÔºÅ`,
                    onConfirm: () => {
                        if (tripDays.length <= 1) return alert("Ëá≥Â∞ëË¶Å‰øùÁïô‰∏ÄÂ§©ÔºÅ");
                        const newDays = tripDays.filter(d => d !== scheduleDay);
                        setTripDays(newDays);
                        setScheduleDay(newDays[0]);
                        setDayViewStartIndex(0);
                        saveSettings({ tripDays: newDays });
                        setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} });
                    }
                });
            };

            const handleAddTransaction = async (e, linkedId = null) => {
                if(e) e.preventDefault();
                if (!amount || !description || !user) return;
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), {
                        amount: parseFloat(amount), description, type, currency, paymentMethod, date, usageType,
                        targetName: usageType === 'self' ? 'Ëá™Áî®' : (targetName || 'Êú™Áü•'), createdAt: serverTimestamp()
                    });
                    if (linkedId) await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'shopping_list', linkedId), { isBought: true, boughtAt: serverTimestamp() });
                    setAmount(''); setDescription(''); if (usageType === 'help_buy') setTargetName('');
                } catch (err) { console.error(err); }
            };

            const handleScheduleSubmit = async (e) => {
                e.preventDefault();
                if (!newEventTitle || !user) return;
                const data = { day: scheduleDay, time: newEventTime || '00:00', title: newEventTitle, location: newEventLocation, createdAt: serverTimestamp() };
                if (editingEventId) { await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'schedule', editingEventId), { time: data.time, title: data.title, location: data.location }); setEditingEventId(null); } 
                else { await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'schedule'), data); }
                setNewEventTitle(''); setNewEventLocation(''); setNewEventTime('');
            };

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file || !user) return;
                setIsAnalyzingImage(true);
                try {
                    const base64Data = await fileToBase64(file);
                    const prompt = `Analyze this itinerary image. Return JSON array of objects: [{"time": "HH:MM", "title": "Activity"}]. Estimate time if missing. Return ONLY JSON.`;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: file.type, data: base64Data } }] }] })
                    });
                    const result = await response.json();
                    let text = result.candidates?.[0]?.content?.parts?.[0]?.text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const events = JSON.parse(text);
                    await Promise.all(events.map(ev => addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'schedule'), { day: scheduleImportTargetDay, time: ev.time||'00:00', title: ev.title||'Êñ∞Ë°åÁ®ã', location: '', createdAt: serverTimestamp() })));
                    setShowScheduleImportModal(false); setScheduleDay(scheduleImportTargetDay);
                } catch (error) { alert("Ëæ®Ë≠òÂ§±Êïó > <"); } 
                finally { setIsAnalyzingImage(false); if(fileInputRef.current) fileInputRef.current.value = ''; }
            };

            const handleUploadCoverPhoto = async (e) => {
                const file = e.target.files[0];
                if (!file || !user) return;
                const reader = new FileReader();
                reader.onload = async () => {
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'daily_photos', scheduleDay), { image: reader.result });
                };
                reader.readAsDataURL(file);
            };

            const stats = useMemo(() => {
                const res = {}; currencies.forEach(c => res[c.code] = { bal: 0, symbol: c.symbol, flag: c.flag });
                transactions.forEach(t => { if(!res[t.currency]) res[t.currency] = { bal: 0, symbol: '$', flag: '?' }; res[t.currency].bal += t.type === 'income' ? t.amount : -t.amount; });
                return res;
            }, [transactions, currencies]);

            const budgetStatus = useMemo(() => {
                let totalSpentTWD = 0;
                transactions.forEach(t => {
                    if (t.type === 'expense' && t.usageType === 'self') {
                        const rate = currencies.find(c => c.code === t.currency)?.rate || 1;
                        totalSpentTWD += t.amount * rate;
                    }
                });
                const percent = Math.min(100, Math.max(0, (totalSpentTWD / totalBudget) * 100));
                return { totalSpentTWD, percent, remaining: totalBudget - totalSpentTWD };
            }, [transactions, totalBudget, currencies]);

            const settlement = useMemo(() => {
                const p = {}; transactions.filter(t => t.usageType === 'help_buy').forEach(t => { if(!p[t.targetName]) p[t.targetName] = {}; if(!p[t.targetName][t.currency]) p[t.targetName][t.currency] = 0; p[t.targetName][t.currency] += t.amount; });
                return p;
            }, [transactions]);

            const visibleDays = useMemo(() => {
                const maxStart = Math.max(0, tripDays.length - 3);
                const safeStart = Math.min(dayViewStartIndex, maxStart);
                return tripDays.slice(safeStart, safeStart + 3);
            }, [tripDays, dayViewStartIndex]);

            // --- Sub-components ---
            const TabButton = ({ id, label, icon: Icon, mainColor }) => (
                React.createElement('button', {
                    onClick: () => setActiveTab(id),
                    className: `flex-1 flex flex-col items-center justify-center py-3 px-1 transition-all duration-300 rounded-xl mx-1 border-2 ${activeTab === id ? `${mainColor} bg-white border-current shadow-md transform -translate-y-1` : 'border-transparent text-gray-400 hover:bg-white/50'}`
                },
                    React.createElement(Icon, { size: 28, strokeWidth: activeTab === id ? 3 : 2, className: "mb-1" }),
                    React.createElement('span', { className: "text-sm font-bold" }, label)
                )
            );

            const BudgetRing = () => {
                const radius = 35;
                const circumference = 2 * Math.PI * radius;
                const strokeDashoffset = circumference - (budgetStatus.percent / 100) * circumference;
                const color = budgetStatus.percent > 90 ? 'text-red-500' : budgetStatus.percent > 70 ? 'text-yellow-500' : 'text-green-500';
                return (
                    React.createElement('div', { className: "bg-white p-5 rounded-3xl shadow-sm border-2 border-gray-100 flex items-center justify-between mb-4" },
                        React.createElement('div', { className: "flex items-center space-x-5" },
                            React.createElement('div', { className: "relative w-20 h-20 flex items-center justify-center" },
                                React.createElement('svg', { className: "w-full h-full transform -rotate-90" },
                                    React.createElement('circle', { cx: "40", cy: "40", r: radius, stroke: "currentColor", strokeWidth: "8", fill: "transparent", className: "text-gray-100" }),
                                    React.createElement('circle', { cx: "40", cy: "40", r: radius, stroke: "currentColor", strokeWidth: "8", fill: "transparent", strokeDasharray: circumference, strokeDashoffset: strokeDashoffset, className: `${color} transition-all duration-1000 ease-out`, strokeLinecap: "round" })
                                ),
                                React.createElement('span', { className: `absolute text-sm font-black ${color}` }, Math.round(budgetStatus.percent) + '%')
                            ),
                            React.createElement('div', null,
                                React.createElement('div', { className: "text-sm text-gray-400 font-bold uppercase tracking-wider mb-1" }, "È†êÁÆóÂâ©È§ò"),
                                React.createElement('div', { className: `text-2xl font-black ${budgetStatus.remaining < 0 ? 'text-red-500' : 'text-gray-800'}` }, "NT$ " + Math.floor(budgetStatus.remaining).toLocaleString()),
                                React.createElement('div', { className: "text-xs text-gray-400 font-bold mt-1" }, "Á∏ΩÈ†êÁÆó: " + totalBudget.toLocaleString())
                            )
                        ),
                        React.createElement('button', { onClick: () => setShowSettingsModal(true), className: "p-3 bg-gray-100 rounded-full text-gray-500 hover:text-blue-500 hover:bg-blue-50 transition-colors" }, React.createElement(Edit2, { size: 20 }))
                    )
                );
            };

            // --- Main Render ---
            return (
                React.createElement('div', { className: `h-[100dvh] w-full font-sans bg-gray-50 flex flex-col text-gray-800 transition-colors duration-500 ${activeTab === 'accounting' ? 'bg-blue-50/30' : activeTab === 'shopping' ? 'bg-yellow-50/30' : 'bg-pink-50/30'}` },
                    /* HEADER */
                    React.createElement('div', { className: "flex-none bg-white/95 backdrop-blur-md shadow-md z-30 pt-safe-top rounded-b-3xl" },
                        React.createElement('div', { className: "max-w-md mx-auto px-4 py-4" },
                            React.createElement('div', { className: "flex items-center justify-between mb-4" },
                                React.createElement('h1', { className: "text-2xl font-black flex items-center tracking-tight" },
                                    activeTab === 'accounting' ? React.createElement(React.Fragment, null, React.createElement(Camera, { className: "mr-2 text-blue-500", size: 28 }), "Â∞èÂÖ´Ë≤ìË®òÂ∏≥") :
                                    activeTab === 'shopping' ? React.createElement(React.Fragment, null, React.createElement(ShoppingBag, { className: "mr-2 text-yellow-500", size: 28 }), "ÁÉèËñ©Â•áË≥ºÁâ©") :
                                    React.createElement(React.Fragment, null, React.createElement(Heart, { className: "mr-2 text-pink-500", size: 28 }), "Âêâ‰ºäÊâãÂ∏≥")
                                ),
                                React.createElement('div', { className: "flex space-x-2" },
                                    React.createElement('button', { onClick: () => setShowSettingsModal(true), className: "p-3 bg-gray-100 rounded-full hover:bg-gray-200 text-gray-600" }, React.createElement(Settings, { size: 22 })),
                                    activeTab === 'accounting' && React.createElement(React.Fragment, null,
                                        React.createElement('button', { onClick: () => setShowCalculatorModal(true), className: "p-3 bg-indigo-100 text-indigo-600 rounded-full" }, React.createElement(Calculator, { size: 22 })),
                                        React.createElement('button', { onClick: () => setShowSettlementModal(true), className: "p-3 bg-pink-100 text-pink-600 rounded-full" }, React.createElement(Users, { size: 22 }))
                                    ),
                                    activeTab === 'shopping' && React.createElement('button', { onClick: () => setShowImportModal(true), className: "px-4 py-2 bg-yellow-400 text-white rounded-full text-base font-black shadow-sm flex items-center" }, React.createElement(Wand2, { size: 18, className: "mr-1" }), "ÂåØÂÖ•"),
                                    activeTab === 'schedule' && React.createElement('button', { onClick: () => setShowScheduleImportModal(true), className: "px-4 py-2 bg-pink-400 text-white rounded-full text-base font-black shadow-sm flex items-center" }, React.createElement(Sparkles, { size: 18, className: "mr-1" }), "ÂåØÂÖ•")
                                )
                            ),
                            React.createElement('div', { className: "flex bg-gray-100/50 p-1 rounded-2xl" },
                                React.createElement(TabButton, { id: "accounting", label: "Ë®òÂ∏≥", icon: Wallet, mainColor: "text-blue-500 border-blue-200" }),
                                React.createElement(TabButton, { id: "shopping", label: "Ë≥ºÁâ©", icon: ShoppingBag, mainColor: "text-yellow-500 border-yellow-200" }),
                                React.createElement(TabButton, { id: "schedule", label: "ÊâãÂ∏≥", icon: Heart, mainColor: "text-pink-500 border-pink-200" })
                            )
                        )
                    ),

                    /* MAIN CONTENT */
                    React.createElement('main', { className: "flex-1 overflow-y-auto pb-10 overscroll-contain" },
                        React.createElement('div', { className: "max-w-md mx-auto px-4 py-6 space-y-8" },
                            /* ACCOUNTING TAB */
                            activeTab === 'accounting' && React.createElement('div', { className: "space-y-6 animate-in fade-in slide-in-from-bottom-2" },
                                React.createElement(BudgetRing),
                                React.createElement('div', { className: "flex space-x-4 overflow-x-auto pb-2 snap-x hide-scrollbar" },
                                    currencies.map(c => {
                                        const data = stats[c.code] || { bal: 0 };
                                        if (data.bal === 0 && c.code !== 'TWD') return null;
                                        return React.createElement('div', { key: c.code, className: "snap-center shrink-0 w-48 bg-white rounded-2xl shadow-sm border-2 border-blue-100 p-4 relative overflow-hidden" },
                                            React.createElement('div', { className: "flex justify-between items-center mb-2" },
                                                React.createElement('span', { className: "text-sm font-black text-blue-500 bg-blue-50 px-2 py-1 rounded-lg" }, c.code),
                                                React.createElement('span', { className: "text-2xl" }, c.flag)
                                            ),
                                            React.createElement('div', { className: "text-2xl font-black text-gray-800" }, c.symbol + " " + data.bal.toLocaleString())
                                        );
                                    })
                                ),
                                React.createElement('div', { className: "bg-white rounded-3xl shadow-lg p-5 border-2 border-white" },
                                    React.createElement('form', { onSubmit: handleAddTransaction, className: "space-y-5" },
                                        React.createElement('div', { className: "flex gap-3" },
                                            React.createElement('div', { className: "flex bg-blue-50 p-1.5 rounded-2xl flex-1" },
                                                ['expense', 'income'].map(t => React.createElement('button', { key: t, type: "button", onClick: () => setType(t), className: `flex-1 py-3 rounded-xl text-base font-black transition-all ${type === t ? 'bg-white text-blue-600 shadow-md' : 'text-gray-400'}` }, t === 'expense' ? 'ÊîØÂá∫' : 'Êî∂ÂÖ•'))
                                            ),
                                            React.createElement('div', { className: "flex bg-pink-50 p-1.5 rounded-2xl flex-1" },
                                                React.createElement('button', { type: "button", onClick: () => setUsageType('self'), className: `flex-1 py-3 rounded-xl text-base font-black transition-all ${usageType === 'self' ? 'bg-white text-pink-600 shadow-md' : 'text-gray-400'}` }, "Ëá™Áî®"),
                                                React.createElement('button', { type: "button", onClick: () => setUsageType('help_buy'), className: `flex-1 py-3 rounded-xl text-base font-black transition-all ${usageType === 'help_buy' ? 'bg-white text-pink-600 shadow-md' : 'text-gray-400'}` }, "‰ª£Ë≥º")
                                            )
                                        ),
                                        usageType === 'help_buy' && React.createElement('input', { type: "text", value: targetName, onChange: e => setTargetName(e.target.value), placeholder: "Âπ´Ë™∞Ë≤∑Ôºü", className: "w-full bg-pink-50 border-2 border-pink-100 rounded-2xl p-4 text-lg font-bold focus:border-pink-400 outline-none", required: true }),
                                        React.createElement('div', { className: "flex gap-3" },
                                            React.createElement('div', { className: "relative flex-1" },
                                                React.createElement('span', { className: "absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-xl" }, getCurrencySymbol(currency)),
                                                React.createElement('input', { type: "number", inputMode: "decimal", value: amount, onChange: e => setAmount(e.target.value), placeholder: "0", className: "w-full pl-12 p-4 bg-gray-50 rounded-2xl text-3xl font-black focus:bg-white focus:ring-4 focus:ring-blue-100 outline-none transition-all h-20", required: true, step: "0.01" })
                                            ),
                                            React.createElement('select', { value: currency, onChange: e => setCurrency(e.target.value), className: "bg-gray-100 border-none rounded-2xl px-3 text-lg font-black w-24 text-center" }, currencies.map(c => React.createElement('option', { key: c.code, value: c.code }, c.code)))
                                        ),
                                        React.createElement('div', { className: "flex gap-3" },
                                            React.createElement('select', { value: paymentMethod, onChange: e => setPaymentMethod(e.target.value), className: "bg-gray-50 border-none rounded-2xl p-4 text-lg font-bold flex-1 h-16" }, paymentMethods.map(p => React.createElement('option', { key: p.id, value: p.id }, p.name))),
                                            React.createElement('input', { type: "date", value: date, onChange: e => setDate(e.target.value), className: "bg-gray-50 border-none rounded-2xl px-3 text-base font-bold w-40 h-16 text-center" })
                                        ),
                                        React.createElement('div', { className: "flex gap-3" },
                                            React.createElement('input', { type: "text", value: description, onChange: e => setDescription(e.target.value), placeholder: "ÂìÅÈ†ÖÂÇôË®ª...", className: "bg-gray-50 border-none rounded-2xl p-4 text-xl font-bold flex-1 h-16", required: true }),
                                            React.createElement('button', { type: "submit", className: "bg-blue-500 hover:bg-blue-600 text-white rounded-2xl px-6 shadow-xl shadow-blue-200 active:scale-95 transition-all flex items-center justify-center" }, React.createElement(Camera, { size: 28, strokeWidth: 3 }))
                                        )
                                    )
                                ),
                                React.createElement('div', { className: "space-y-4" },
                                    transactions.map(t => (
                                        React.createElement('div', { key: t.id, className: "bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between" },
                                            React.createElement('div', { className: "flex items-center space-x-4" },
                                                React.createElement('div', { className: `w-12 h-12 rounded-full flex items-center justify-center text-2xl ${t.type === 'income' ? 'bg-green-100 text-green-600' : 'bg-red-50 text-red-500'}` }, t.type === 'income' ? '+' : '-'),
                                                React.createElement('div', null,
                                                    React.createElement('div', { className: "flex items-center space-x-2" },
                                                        React.createElement('span', { className: "font-bold text-gray-800 text-lg" }, t.description),
                                                        t.usageType === 'help_buy' && React.createElement('span', { className: "text-xs bg-pink-100 text-pink-600 px-2 py-1 rounded font-bold" }, t.targetName)
                                                    ),
                                                    React.createElement('div', { className: "text-sm text-gray-400 font-bold" }, t.date + " ‚Ä¢ " + (paymentMethods.find(p => p.id === t.paymentMethod)?.name || t.paymentMethod))
                                                )
                                            ),
                                            React.createElement('div', { className: "flex items-center space-x-3" },
                                                React.createElement('div', { className: "text-right" },
                                                    React.createElement('div', { className: `font-black text-xl ${t.type === 'income' ? 'text-green-600' : 'text-gray-900'}` }, getCurrencySymbol(t.currency) + " " + t.amount.toLocaleString()),
                                                    React.createElement('div', { className: "text-sm text-gray-400 font-bold" }, t.currency)
                                                ),
                                                React.createElement('button', { onClick: () => deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'transactions', t.id)), className: "text-gray-300 hover:text-red-500 p-2" }, React.createElement(Trash2, { size: 24 }))
                                            )
                                        )
                                    ))
                                )
                            ),

                            /* SHOPPING TAB */
                            activeTab === 'shopping' && React.createElement('div', { className: "space-y-4 animate-in fade-in slide-in-from-bottom-2" },
                                shoppingList.length === 0 ? React.createElement('div', { className: "text-center py-20 text-gray-400" }, React.createElement(ShoppingBag, { size: 64, className: "mx-auto mb-4 opacity-30" }), React.createElement('p', { className: "text-xl font-bold" }, "Ê∏ÖÂñÆÁ©∫Á©∫ÁöÑÔºåÂø´ÂåØÂÖ•ÂêßÔºÅ")) :
                                shoppingList.map(item => (
                                    React.createElement('div', { key: item.id, className: `p-5 rounded-2xl border-2 flex items-center justify-between ${item.isBought ? 'bg-gray-50 border-gray-100 opacity-60' : 'bg-white border-yellow-100 shadow-sm'}` },
                                        React.createElement('div', { className: "flex items-center space-x-4" },
                                            React.createElement('div', { className: `w-8 h-8 rounded-full border-2 flex items-center justify-center ${item.isBought ? 'bg-green-500 border-green-500 text-white' : 'border-gray-200 text-transparent'}` }, React.createElement(CheckCircle, { size: 20, fill: "currentColor" })),
                                            React.createElement('span', { className: `font-bold text-xl ${item.isBought ? 'line-through text-gray-400' : 'text-gray-800'}` }, item.item)
                                        ),
                                        !item.isBought ? React.createElement('button', { onClick: () => { setDescription(item.item); setActiveTab('accounting'); window.scrollTo({ top: 0, behavior: 'smooth' }); }, className: "bg-yellow-400 text-white px-5 py-3 rounded-2xl text-lg font-black shadow-md active:scale-95" }, "Ë≤∑‰∫ÜÔºÅ") :
                                        React.createElement('button', { onClick: () => deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'shopping_list', item.id)), className: "text-gray-300 hover:text-red-500 p-2" }, React.createElement(Trash2, { size: 24 }))
                                    )
                                ))
                            ),

                            /* SCHEDULE TAB */
                            activeTab === 'schedule' && React.createElement('div', { className: "space-y-6 animate-in fade-in slide-in-from-bottom-2" },
                                /* Cover Photo */
                                React.createElement('div', { className: "relative w-full h-48 bg-gray-100 rounded-3xl overflow-hidden group shadow-inner border-4 border-white" },
                                    dailyPhotos[scheduleDay] ? React.createElement('img', { src: dailyPhotos[scheduleDay], alt: "Cover", className: "w-full h-full object-cover" }) : React.createElement('div', { className: "w-full h-full flex flex-col items-center justify-center text-gray-300" }, React.createElement(ImageIcon, { size: 48, className: "mb-2" }), React.createElement('span', { className: "text-base font-bold" }, "ÈªûÊìäË®≠ÂÆöÊú¨Êó•Â∞ÅÈù¢")),
                                    React.createElement('div', { className: "absolute inset-0 bg-black/20 group-hover:bg-black/40 transition-colors flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer" },
                                        React.createElement('input', { type: "file", ref: photoInputRef, accept: "image/*", onChange: handleUploadCoverPhoto, className: "hidden", id: "cover-upload" }),
                                        React.createElement('label', { htmlFor: "cover-upload", className: "text-white font-black text-xl flex items-center cursor-pointer bg-black/30 px-4 py-2 rounded-full backdrop-blur-md" }, React.createElement(Camera, { className: "mr-2", size: 24 }), " Êõ¥ÊèõÂ∞ÅÈù¢")
                                    )
                                ),

                                /* Day Selector */
                                React.createElement('div', { className: "flex items-center justify-between bg-white p-3 rounded-2xl shadow-sm" },
                                    React.createElement('button', { onClick: () => setDayViewStartIndex(Math.max(0, dayViewStartIndex - 1)), disabled: dayViewStartIndex === 0, className: "p-3 text-gray-400 disabled:opacity-20 hover:text-pink-500" }, React.createElement(ChevronLeft, { size: 28 })),
                                    React.createElement('div', { className: "flex gap-2 overflow-hidden flex-1 justify-center" },
                                        visibleDays.map(d => React.createElement('button', { key: d, onClick: () => setScheduleDay(d), className: `px-5 py-3 rounded-xl text-base font-bold transition-all ${scheduleDay === d ? 'bg-pink-500 text-white shadow-md scale-105' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}` }, d)),
                                        React.createElement('button', { onClick: handleAddDay, className: "px-4 py-3 rounded-xl border-2 border-dashed border-pink-300 text-pink-300 hover:bg-pink-50", title: "Êñ∞Â¢ûÂ§©Êï∏" }, React.createElement(Plus, { size: 20 }))
                                    ),
                                    React.createElement('button', { onClick: () => setDayViewStartIndex(Math.min(tripDays.length - 3, dayViewStartIndex + 1)), disabled: dayViewStartIndex >= tripDays.length - 3, className: "p-3 text-gray-400 disabled:opacity-20 hover:text-pink-500" }, React.createElement(ChevronRight, { size: 28 }))
                                ),
                                React.createElement('div', { className: "flex justify-end px-2" },
                                    React.createElement('button', { onClick: handleDeleteCurrentDay, className: "text-red-400 text-sm font-bold flex items-center bg-red-50 px-3 py-1 rounded-lg" }, React.createElement(Trash2, { size: 14, className: "mr-1" }), " Âà™Èô§ " + scheduleDay)
                                ),

                                /* Event Form */
                                React.createElement('form', { onSubmit: handleScheduleSubmit, className: `p-5 rounded-3xl shadow-sm border-2 space-y-4 transition-colors ${editingEventId ? 'bg-pink-50 border-pink-200' : 'bg-white border-pink-100'}` },
                                    React.createElement('div', { className: "flex items-center justify-between" },
                                        React.createElement('span', { className: "text-sm font-bold text-pink-400" }, editingEventId ? '‚úèÔ∏è ‰øÆÊîπË°åÁ®ã' : '‚ú® Êñ∞Â¢ûÂõûÊÜ∂'),
                                        editingEventId && React.createElement('button', { type: "button", onClick: () => { setEditingEventId(null); setNewEventTitle(''); setNewEventLocation(''); setNewEventTime(''); }, className: "text-sm font-bold text-gray-400" }, "ÂèñÊ∂à")
                                    ),
                                    React.createElement('div', { className: "flex space-x-3" },
                                        React.createElement('input', { type: "time", value: newEventTime, onChange: e => setNewEventTime(e.target.value), className: "bg-gray-50 rounded-2xl px-3 text-lg font-bold outline-none border-2 border-transparent focus:bg-white focus:border-pink-300 h-14" }),
                                        React.createElement('input', { type: "text", value: newEventTitle, onChange: e => setNewEventTitle(e.target.value), placeholder: "Ë¶ÅÂÅö‰ªÄÈ∫ºÂë¢Ôºü", className: "flex-1 bg-gray-50 rounded-2xl px-4 py-3 text-lg font-bold outline-none border-2 border-transparent focus:bg-white focus:border-pink-300 h-14", required: true })
                                    ),
                                    React.createElement('div', { className: "flex items-center space-x-3" },
                                        React.createElement(MapPin, { size: 24, className: "text-pink-300" }),
                                        React.createElement('input', { type: "text", value: newEventLocation, onChange: e => setNewEventLocation(e.target.value), placeholder: "Âú∞Èªû (ÂèØÈÅ∏)", className: "flex-1 bg-transparent border-b-2 border-pink-100 text-lg py-2 outline-none focus:border-pink-400 text-gray-500 font-bold" }),
                                        React.createElement('button', { type: "submit", className: `p-3 rounded-full shadow-lg text-white transition-transform active:scale-95 ${editingEventId ? 'bg-green-400' : 'bg-pink-400'}` }, editingEventId ? React.createElement(Save, { size: 24 }) : React.createElement(Plus, { size: 28 }))
                                    )
                                ),

                                /* Timeline */
                                React.createElement('div', { className: "relative pl-6 space-y-5 pb-10" },
                                    React.createElement('div', { className: "absolute left-9 top-0 bottom-0 w-1 bg-pink-200 rounded-full" }),
                                    schedule.filter(s => s.day === scheduleDay).length === 0 ? React.createElement('div', { className: "text-center py-16 pl-6 text-gray-400 text-lg font-bold" }, "ÈÄôÂ§©ÈÇÑÊ≤íÊúâÂÆâÊéíË°åÁ®ãÂñî") :
                                    schedule.filter(s => s.day === scheduleDay).map((event) => (
                                        React.createElement('div', { key: event.id, className: `relative flex items-start space-x-5 group ${editingEventId === event.id ? 'opacity-50' : ''}` },
                                            React.createElement('div', { className: "absolute left-2 mt-2 w-5 h-5 bg-pink-400 rounded-full ring-4 ring-white z-10 shadow-sm" }),
                                            React.createElement('div', { className: "flex-1 bg-white p-5 rounded-3xl shadow-sm border-2 border-pink-50 relative hover:border-pink-200 transition-colors" },
                                                React.createElement('div', { className: "flex justify-between items-start mb-2" },
                                                    React.createElement('span', { className: "inline-block bg-pink-50 text-pink-600 text-sm px-3 py-1 rounded-full font-black tracking-wider" }, event.time),
                                                    React.createElement('div', { className: "flex space-x-3" },
                                                        React.createElement('button', { onClick: () => { setEditingEventId(event.id); setNewEventTime(event.time); setNewEventTitle(event.title); setNewEventLocation(event.location || ''); }, className: "text-gray-300 hover:text-blue-400" }, React.createElement(Edit2, { size: 20 })),
                                                        React.createElement('button', { onClick: () => { if(window.confirm('Âà™Èô§Ôºü')) deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'schedule', event.id)) }, className: "text-gray-300 hover:text-red-400" }, React.createElement(Trash2, { size: 20 }))
                                                    )
                                                ),
                                                React.createElement('h3', { className: "font-black text-gray-800 text-xl" }, event.title),
                                                event.location && React.createElement('div', { className: "flex items-center mt-3 space-x-3" },
                                                    React.createElement('div', { className: "flex items-center text-sm font-bold text-gray-500" }, React.createElement(MapPin, { size: 16, className: "mr-1" }), " " + event.location),
                                                    React.createElement('a', { href: `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.location)}`, target: "_blank", rel: "noopener noreferrer", className: "text-xs bg-green-50 text-green-600 px-3 py-1 rounded-full flex items-center hover:bg-green-100 font-bold border border-green-200" }, React.createElement(Map, { size: 14, className: "mr-1" }), " Â∞éËà™")
                                                )
                                            )
                                        )
                                    ))
                                )
                            )
                        )
                    ),

                    /* MODALS */
                    /* Generic Confirmation Modal */
                    confirmModal.show && React.createElement('div', { className: "fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm", onClick: () => setConfirmModal({ ...confirmModal, show: false }) },
                        React.createElement('div', { className: "bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl", onClick: e => e.stopPropagation() },
                            React.createElement('div', { className: "text-center mb-4" },
                                React.createElement('div', { className: "bg-red-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2" }, React.createElement(AlertTriangle, { className: "text-red-500", size: 24 })),
                                React.createElement('h3', { className: "text-xl font-black text-gray-800" }, confirmModal.title),
                                React.createElement('p', { className: "text-gray-500 mt-2" }, confirmModal.message)
                            ),
                            React.createElement('div', { className: "flex gap-3" },
                                React.createElement('button', { onClick: () => setConfirmModal({ ...confirmModal, show: false }), className: "flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold" }, "ÂèñÊ∂à"),
                                React.createElement('button', { onClick: confirmModal.onConfirm, className: "flex-1 py-3 bg-red-500 text-white rounded-xl font-bold shadow-lg" }, "Á¢∫ÂÆöÂà™Èô§")
                            )
                        )
                    ),

                    /* Settings Modal */
                    showSettingsModal && React.createElement('div', { className: "fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm animate-in fade-in", onClick: () => setShowSettingsModal(false) },
                        React.createElement('div', { className: "bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl h-[80vh] overflow-y-auto", onClick: e => e.stopPropagation() },
                            React.createElement('div', { className: "flex justify-between items-center mb-6" },
                                React.createElement('h2', { className: "text-2xl font-black flex items-center" }, React.createElement(Settings, { className: "mr-3", size: 28 }), " Ë®≠ÂÆö‰∏≠ÂøÉ"),
                                React.createElement('button', { onClick: () => setShowSettingsModal(false), className: "bg-gray-100 p-3 rounded-full" }, React.createElement(X, { size: 24 }))
                            ),
                            React.createElement('div', { className: "mb-8 p-5 bg-blue-50 rounded-2xl border-2 border-blue-100" },
                                React.createElement('label', { className: "text-lg font-bold text-blue-600 block mb-2" }, "üí∞ Á∏ΩÈ†êÁÆó (Âè∞Âπ£)"),
                                React.createElement('input', { type: "number", value: totalBudget, onChange: e => { const v = parseInt(e.target.value); setTotalBudget(v); saveSettings({ totalBudget: v }); }, className: "w-full bg-white rounded-xl p-3 font-bold text-2xl outline-none focus:ring-4 focus:ring-blue-200" })
                            ),

                            /* Payment Methods */
                            React.createElement('div', { className: "mb-8" },
                                React.createElement('h3', { className: "text-xl font-bold text-gray-700 mb-4" }, "üí≥ ÊîØ‰ªòÂ∑•ÂÖ∑"),
                                React.createElement('div', { className: "space-y-3 mb-4" },
                                    paymentMethods.map(p => React.createElement('div', { key: p.id, className: "flex justify-between bg-gray-50 p-4 rounded-xl border border-gray-100 items-center" },
                                        React.createElement('span', { className: "font-bold text-lg" }, p.name),
                                        React.createElement('button', { onClick: () => handleDeletePaymentMethod(p.id), className: "text-gray-300 hover:text-red-500 p-2" }, React.createElement(Trash2, { size: 20 }))
                                    ))
                                ),
                                React.createElement('div', { className: "flex gap-2 bg-blue-50 p-2 rounded-xl" },
                                    React.createElement('input', { value: newPaymentName, onChange: e => setNewPaymentName(e.target.value), placeholder: "Êñ∞Â¢ûÊîØ‰ªòÂêçÁ®±...", className: "flex-1 bg-white rounded-lg px-3 text-lg font-bold outline-none" }),
                                    React.createElement('button', { onClick: handleAddPaymentMethod, className: "bg-blue-500 text-white px-4 py-2 rounded-lg font-bold" }, "Êñ∞Â¢û")
                                )
                            ),

                            /* Currencies */
                            React.createElement('div', { className: "mb-8" },
                                React.createElement('h3', { className: "text-xl font-bold text-gray-700 mb-4" }, "üí± Âπ£Âà•ÂåØÁéá"),
                                React.createElement('div', { className: "space-y-3 mb-4" },
                                    currencies.map(c => React.createElement('div', { key: c.code, className: "flex justify-between items-center bg-gray-50 p-4 rounded-xl border border-gray-100" },
                                        React.createElement('div', { className: "flex items-center" },
                                            React.createElement('span', { className: "mr-3 text-2xl" }, c.flag),
                                            React.createElement('span', { className: "font-black text-lg" }, c.code),
                                            React.createElement('span', { className: "text-sm text-gray-400 mx-3 font-bold" }, "ÂåØÁéá:"),
                                            React.createElement('input', { type: "number", value: c.rate, onChange: e => { const m = currencies.map(x => x.code === c.code ? { ...x, rate: parseFloat(e.target.value) } : x); setCurrencies(m); saveSettings({ currencies: m }); }, className: "w-20 bg-white rounded-lg px-2 py-1 text-base font-bold border" })
                                        ),
                                        React.createElement('button', { onClick: () => handleDeleteCurrency(c.code), className: "text-gray-300 hover:text-red-500 p-2" }, React.createElement(Trash2, { size: 20 }))
                                    ))
                                ),
                                React.createElement('div', { className: "flex gap-2 bg-green-50 p-2 rounded-xl" },
                                    React.createElement('input', { value: newCurrencyCode, onChange: e => setNewCurrencyCode(e.target.value), placeholder: "‰ª£Á¢º", className: "w-24 bg-white rounded-lg px-3 text-lg font-bold outline-none" }),
                                    React.createElement('input', { value: newCurrencyRate, onChange: e => setNewCurrencyRate(e.target.value), placeholder: "ÂåØÁéá", type: "number", className: "flex-1 bg-white rounded-lg px-3 text-lg font-bold outline-none" }),
                                    React.createElement('button', { onClick: handleAddCurrency, className: "bg-green-500 text-white px-4 py-2 rounded-lg font-bold" }, "Êñ∞Â¢û")
                                )
                            )
                        )
                    ),

                    /* Calculator Modal */
                    showCalculatorModal && React.createElement('div', { className: "fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm animate-in fade-in", onClick: () => setShowCalculatorModal(false) },
                        React.createElement('div', { className: "bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl", onClick: e => e.stopPropagation() },
                            React.createElement('h3', { className: "text-2xl font-black mb-6 flex items-center" }, React.createElement(Calculator, { className: "mr-3 text-indigo-500", size: 32 }), " ÂåØÁéáË©¶ÁÆó"),
                            React.createElement('div', { className: "space-y-6" },
                                React.createElement('div', null,
                                    React.createElement('label', { className: "text-sm text-gray-500 font-bold block mb-2" }, "ÂåØÁéá"),
                                    React.createElement('input', { type: "number", value: calcRate, onChange: e => setCalcRate(e.target.value), className: "w-full bg-indigo-50 rounded-2xl p-4 text-2xl font-black text-indigo-900 outline-none" })
                                ),
                                React.createElement('div', null,
                                    React.createElement('label', { className: "text-sm text-gray-500 font-bold block mb-2" }, "Â§ñÂπ£ÈáëÈ°ç"),
                                    React.createElement('input', { type: "number", value: calcAmount, onChange: e => setCalcAmount(e.target.value), className: "w-full bg-gray-50 rounded-2xl p-4 text-2xl font-black outline-none" })
                                ),
                                React.createElement('div', { className: "bg-gray-100 rounded-2xl p-6 text-center" },
                                    React.createElement('div', { className: "text-sm text-gray-500 font-bold mb-1" }, "Á¥ÑÂêàÂè∞Âπ£"),
                                    React.createElement('div', { className: "text-4xl font-black text-gray-800" }, "NT$ " + Math.round(calcAmount * calcRate).toLocaleString())
                                )
                            )
                        )
                    ),

                    /* Import Modal */
                    showImportModal && React.createElement('div', { className: "fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm", onClick: () => setShowImportModal(false) },
                        React.createElement('div', { className: "bg-white w-full max-w-md p-8 rounded-3xl shadow-2xl", onClick: e => e.stopPropagation() },
                            React.createElement('h3', { className: "text-2xl font-black text-yellow-600 mb-4" }, "È≠îÊ≥ïÂåØÂÖ•"),
                            React.createElement('textarea', { value: importText, onChange: e => setImportText(e.target.value), className: "w-full h-48 bg-yellow-50 rounded-2xl p-4 text-lg mb-6 border-none font-medium" }),
                            React.createElement('button', {
                                onClick: async () => {
                                    const l = importText.split(/\r?\n/).filter(x => x.trim());
                                    await Promise.all(l.map(i => addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'shopping_list'), { item: i, isBought: false, createdAt: serverTimestamp() })));
                                    setShowImportModal(false);
                                },
                                className: "w-full py-4 bg-yellow-400 text-white rounded-2xl text-xl font-black shadow-lg"
                            }, "ËÆäËÆäËÆäÔºÅ")
                        )
                    ),

                    /* Schedule Import Modal */
                    showScheduleImportModal && React.createElement('div', { className: "fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm", onClick: () => setShowScheduleImportModal(false) },
                        React.createElement('div', { className: "bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl h-[90vh] overflow-y-auto", onClick: e => e.stopPropagation() },
                            React.createElement('h3', { className: "text-2xl font-black mb-6 text-pink-500" }, "ÂåØÂÖ•ÂõûÊÜ∂"),
                            React.createElement('select', { value: scheduleImportTargetDay, onChange: e => setScheduleImportTargetDay(e.target.value), className: "w-full bg-pink-50 rounded-2xl p-4 mb-6 text-xl font-bold text-pink-600 border-none" },
                                tripDays.map(d => React.createElement('option', { key: d, value: d }, d))
                            ),
                            React.createElement('div', { className: "mb-6 border-4 border-dashed border-pink-200 rounded-3xl p-8 text-center bg-pink-50/50" },
                                React.createElement('input', { type: "file", ref: fileInputRef, accept: "image/*", onChange: handleImageUpload, className: "hidden", id: "img-upload" }),
                                React.createElement('label', { htmlFor: "img-upload", className: "flex flex-col items-center justify-center cursor-pointer text-pink-400" },
                                    isAnalyzingImage ? React.createElement(Loader2, { className: "animate-spin", size: 48 }) : React.createElement(React.Fragment, null, React.createElement(ImageIcon, { size: 48 }), React.createElement('span', { className: "text-lg font-bold mt-2" }, "‰∏äÂÇ≥ÂúñÁâáËæ®Ë≠ò"))
                                )
                            ),
                            React.createElement('textarea', { value: scheduleImportText, onChange: e => setScheduleImportText(e.target.value), className: "w-full h-32 bg-gray-50 rounded-2xl p-4 mb-6 text-lg", placeholder: "ÊàñË≤º‰∏äÊñáÂ≠ó..." }),
                            React.createElement('button', {
                                onClick: async () => {
                                    const lines = scheduleImportText.split(/\r?\n/);
                                    await Promise.all(lines.map(line => {
                                        const m = line.trim().match(/(\d{1,2}[:Ôºö]\d{2})/);
                                        if (m) addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'schedule'), { day: scheduleImportTargetDay, time: m[1].replace('Ôºö', ':').padStart(5, '0'), title: line.replace(m[0], '').trim().replace(/^[:Ôºö\-\s]+/, ''), location: '', createdAt: serverTimestamp() });
                                    }));
                                    setShowScheduleImportModal(false);
                                },
                                className: "w-full py-4 bg-pink-400 text-white rounded-2xl text-xl font-black shadow-lg"
                            }, "ÊñáÂ≠óÂåØÂÖ•")
                        )
                    ),

                    /* Settlement Modal */
                    showSettlementModal && React.createElement('div', { className: "fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm", onClick: () => setShowSettlementModal(false) },
                        React.createElement('div', { className: "bg-white w-full max-w-md rounded-3xl p-8 h-[80vh] flex flex-col", onClick: e => e.stopPropagation() },
                            React.createElement('h3', { className: "font-black text-2xl mb-6" }, "‰ª£Ë≥ºÁµêÁÆó"),
                            React.createElement('div', { className: "flex-1 overflow-y-auto" },
                                Object.keys(settlement).length === 0 ? React.createElement('p', { className: "text-gray-400 text-center text-xl mt-10" }, "ÁÑ°Ë≥áÊñô") :
                                Object.entries(settlement).map(([n, c]) => (
                                    React.createElement('div', { key: n, className: "mb-6 border-b-2 pb-4" },
                                        React.createElement('div', { className: "font-black text-xl mb-2 flex items-center" },
                                            React.createElement('span', { className: "w-3 h-3 bg-blue-500 rounded-full mr-3" }),
                                            n
                                        ),
                                        Object.entries(c).map(([curr, v]) => (
                                            React.createElement('div', { key: curr, className: "flex justify-between text-lg mb-1" },
                                                React.createElement('span', { className: "text-gray-500 font-bold" }, curr),
                                                React.createElement('span', { className: "font-black text-blue-600" }, getCurrencySymbol(curr) + v.toLocaleString())
                                            )
                                        ))
                                    )
                                ))
                            )
                        )
                    ),

                    /* Install Guide Modal */
                    showInstallGuide && React.createElement('div', { className: "fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/60 backdrop-blur-md", onClick: () => setShowInstallGuide(false) },
                        React.createElement('div', { className: "bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl relative", onClick: e => e.stopPropagation() },
                            React.createElement('h3', { className: "text-2xl font-black text-gray-800 mb-6 flex items-center" }, React.createElement(Smartphone, { className: "mr-3", size: 28 }), " Âä†ÂÖ•‰∏ªÁï´Èù¢"),
                            React.createElement('div', { className: "space-y-6 text-lg text-gray-600" },
                                React.createElement('div', { className: "flex items-start" },
                                    React.createElement('span', { className: "bg-gray-100 px-3 py-1 rounded-lg mr-3 font-bold text-base" }, "iOS"),
                                    React.createElement('p', null, "ÈªûÊìä‰∏ãÊñπ„ÄåÂàÜ‰∫´„Äç", React.createElement(Share, { size: 16, className: "inline" }), "ÔºåÂæÄ‰∏ãÊªëÈªûÊìä„ÄåÂä†ÂÖ•‰∏ªÁï´Èù¢„Äç„ÄÇ")
                                ),
                                React.createElement('div', { className: "flex items-start" },
                                    React.createElement('span', { className: "bg-gray-100 px-3 py-1 rounded-lg mr-3 font-bold text-base" }, "Android"),
                                    React.createElement('p', null, "ÈªûÊìäÈÅ∏ÂñÆÔºåÈÅ∏Êìá„ÄåÂä†Âà∞‰∏ªÁï´Èù¢„ÄçÊàñ„ÄåÂÆâË£ù„Äç„ÄÇ")
                                )
                            ),
                            React.createElement('button', { onClick: () => setShowInstallGuide(false), className: "w-full mt-8 py-4 bg-gray-800 text-white font-black text-xl rounded-2xl" }, "Áü•ÈÅì‰∫Ü")
                        )
                    )
                )
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
